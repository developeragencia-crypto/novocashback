/**
 * An√°lise Completa do Sistema Vale Cashback
 * Testa todas as funcionalidades, APIs e componentes
 */

import { Pool } from 'pg';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Configura√ß√£o do banco
const pool = new Pool({
  host: process.env.PGHOST || 'localhost',
  port: process.env.PGPORT || 5432,
  user: process.env.PGUSER || 'postgres',
  password: process.env.PGPASSWORD || '',
  database: process.env.PGDATABASE || 'valecashback',
});

class SystemAnalyzer {
  constructor() {
    this.results = {
      database: { status: 'pending', tests: [] },
      apis: { status: 'pending', tests: [] },
      clientPanel: { status: 'pending', tests: [] },
      merchantPanel: { status: 'pending', tests: [] },
      adminPanel: { status: 'pending', tests: [] },
      components: { status: 'pending', tests: [] },
      authentication: { status: 'pending', tests: [] }
    };
  }

  async runCompleteAnalysis() {
    console.log('üîç INICIANDO AN√ÅLISE COMPLETA DO SISTEMA VALE CASHBACK');
    console.log('=' * 60);

    try {
      await this.testDatabase();
      await this.testAPIs();
      await this.testAuthentication();
      await this.analyzeClientPanel();
      await this.analyzeMerchantPanel();
      await this.analyzeAdminPanel();
      await this.analyzeComponents();
      
      this.generateReport();
    } catch (error) {
      console.error('‚ùå Erro na an√°lise:', error);
    } finally {
      await pool.end();
    }
  }

  async testDatabase() {
    console.log('\nüìä TESTANDO BANCO DE DADOS');
    console.log('-'.repeat(40));

    const tests = [
      { name: 'Conex√£o com PostgreSQL', test: () => pool.query('SELECT 1') },
      { name: 'Tabela users', test: () => pool.query('SELECT COUNT(*) FROM users') },
      { name: 'Tabela merchants', test: () => pool.query('SELECT COUNT(*) FROM merchants') },
      { name: 'Tabela transactions', test: () => pool.query('SELECT COUNT(*) FROM transactions') },
      { name: 'Tabela cashbacks', test: () => pool.query('SELECT COUNT(*) FROM cashbacks') },
      { name: 'Tabela products', test: () => pool.query('SELECT COUNT(*) FROM products') },
      { name: 'Configura√ß√µes sistema', test: () => pool.query('SELECT COUNT(*) FROM commission_settings') }
    ];

    for (const test of tests) {
      try {
        const result = await test.test();
        const count = result.rows[0].count || result.rows[0]['?column?'];
        console.log(`‚úÖ ${test.name}: ${count || 'OK'}`);
        this.results.database.tests.push({ name: test.name, status: 'pass', data: count });
      } catch (error) {
        console.log(`‚ùå ${test.name}: ${error.message}`);
        this.results.database.tests.push({ name: test.name, status: 'fail', error: error.message });
      }
    }

    // Verificar usu√°rios por tipo
    try {
      const userTypes = await pool.query(`
        SELECT type, COUNT(*) as count 
        FROM users 
        GROUP BY type 
        ORDER BY type
      `);
      
      console.log('\nüìã Usu√°rios por tipo:');
      userTypes.rows.forEach(row => {
        console.log(`   ${row.type}: ${row.count} usu√°rios`);
      });
    } catch (error) {
      console.log(`‚ùå Erro ao verificar tipos de usu√°rio: ${error.message}`);
    }

    this.results.database.status = 'completed';
  }

  async testAPIs() {
    console.log('\nüîó TESTANDO APIs DO SISTEMA');
    console.log('-'.repeat(40));

    const apiEndpoints = [
      // Auth APIs
      { method: 'GET', url: '/api/auth/me', description: 'Verificar usu√°rio logado' },
      
      // Client APIs
      { method: 'GET', url: '/api/client/dashboard', description: 'Dashboard do cliente', userType: 'client' },
      { method: 'GET', url: '/api/client/transactions', description: 'Transa√ß√µes do cliente', userType: 'client' },
      { method: 'GET', url: '/api/client/cashbacks', description: 'Cashbacks do cliente', userType: 'client' },
      { method: 'GET', url: '/api/client/referrals', description: 'Indica√ß√µes do cliente', userType: 'client' },
      { method: 'GET', url: '/api/client/profile', description: 'Perfil do cliente', userType: 'client' },
      
      // Merchant APIs
      { method: 'GET', url: '/api/merchant/dashboard', description: 'Dashboard do lojista', userType: 'merchant' },
      { method: 'GET', url: '/api/merchant/products', description: 'Produtos do lojista', userType: 'merchant' },
      { method: 'GET', url: '/api/merchant/transactions', description: 'Transa√ß√µes do lojista', userType: 'merchant' },
      
      // Admin APIs
      { method: 'GET', url: '/api/admin/dashboard', description: 'Dashboard do admin', userType: 'admin' },
      { method: 'GET', url: '/api/admin/users', description: 'Usu√°rios do sistema', userType: 'admin' },
      { method: 'GET', url: '/api/admin/merchants', description: 'Lojistas do sistema', userType: 'admin' },
      { method: 'GET', url: '/api/admin/transactions', description: 'Todas as transa√ß√µes', userType: 'admin' },
      
      // Public APIs
      { method: 'GET', url: '/api/referrals/code', description: 'C√≥digo de indica√ß√£o' },
      { method: 'GET', url: '/api/system/status', description: 'Status do sistema' }
    ];

    // Testar APIs p√∫blicas
    for (const api of apiEndpoints.filter(a => !a.userType)) {
      try {
        const response = await fetch(`http://localhost:3000${api.url}`);
        const status = response.status;
        
        if (status === 401) {
          console.log(`üîí ${api.description}: Requer autentica√ß√£o (${status})`);
          this.results.apis.tests.push({ ...api, status: 'auth_required' });
        } else if (status >= 200 && status < 300) {
          console.log(`‚úÖ ${api.description}: OK (${status})`);
          this.results.apis.tests.push({ ...api, status: 'pass' });
        } else {
          console.log(`‚ö†Ô∏è ${api.description}: Status ${status}`);
          this.results.apis.tests.push({ ...api, status: 'warning', code: status });
        }
      } catch (error) {
        console.log(`‚ùå ${api.description}: ${error.message}`);
        this.results.apis.tests.push({ ...api, status: 'fail', error: error.message });
      }
    }

    this.results.apis.status = 'completed';
  }

  async testAuthentication() {
    console.log('\nüîê TESTANDO SISTEMA DE AUTENTICA√á√ÉO');
    console.log('-'.repeat(40));

    // Verificar usu√°rios de teste no banco
    try {
      const testUsers = await pool.query(`
        SELECT email, type, name 
        FROM users 
        WHERE email IN ('alex@valecashback.com', 'joao.silva@email.com', 'ana@valecashback.com')
        ORDER BY type
      `);

      console.log('üë• Usu√°rios de teste dispon√≠veis:');
      testUsers.rows.forEach(user => {
        console.log(`   ${user.type}: ${user.email} (${user.name})`);
      });

      this.results.authentication.tests.push({
        name: 'Usu√°rios de teste',
        status: 'pass',
        data: testUsers.rows
      });
    } catch (error) {
      console.log(`‚ùå Erro ao verificar usu√°rios: ${error.message}`);
      this.results.authentication.tests.push({
        name: 'Usu√°rios de teste',
        status: 'fail',
        error: error.message
      });
    }

    this.results.authentication.status = 'completed';
  }

  async analyzeClientPanel() {
    console.log('\nüë§ ANALISANDO PAINEL DO CLIENTE');
    console.log('-'.repeat(40));

    const clientPages = [
      { path: '/client/dashboard', name: 'Dashboard', component: 'ClientDashboard' },
      { path: '/client/transactions', name: 'Transa√ß√µes', component: 'ClientTransactions' },
      { path: '/client/cashbacks', name: 'Cashbacks', component: 'ClientCashbacks' },
      { path: '/client/referrals', name: 'Indica√ß√µes', component: 'ClientReferrals' },
      { path: '/client/profile', name: 'Perfil', component: 'ClientProfile' },
      { path: '/client/stores', name: 'Lojas', component: 'ClientStores' },
      { path: '/client/qr-code', name: 'QR Code', component: 'ClientQRCode' },
      { path: '/client/scanner', name: 'Scanner', component: 'ClientScanner' },
      { path: '/client/transfers', name: 'Transfer√™ncias', component: 'ClientTransfers' }
    ];

    for (const page of clientPages) {
      const componentPath = `client/src/pages/client/${page.component.toLowerCase().replace('client', '')}.tsx`;
      const exists = fs.existsSync(componentPath);
      
      if (exists) {
        try {
          const content = fs.readFileSync(componentPath, 'utf8');
          const hasQuery = content.includes('useQuery');
          const hasAPI = content.includes('/api/');
          const hasAuth = content.includes('useAuth');
          
          console.log(`‚úÖ ${page.name}: Componente OK (Query: ${hasQuery}, API: ${hasAPI}, Auth: ${hasAuth})`);
          this.results.clientPanel.tests.push({
            name: page.name,
            path: page.path,
            status: 'pass',
            features: { hasQuery, hasAPI, hasAuth }
          });
        } catch (error) {
          console.log(`‚ö†Ô∏è ${page.name}: Erro ao analisar componente`);
          this.results.clientPanel.tests.push({
            name: page.name,
            path: page.path,
            status: 'warning',
            error: error.message
          });
        }
      } else {
        console.log(`‚ùå ${page.name}: Componente n√£o encontrado`);
        this.results.clientPanel.tests.push({
          name: page.name,
          path: page.path,
          status: 'fail',
          error: 'Componente n√£o encontrado'
        });
      }
    }

    this.results.clientPanel.status = 'completed';
  }

  async analyzeMerchantPanel() {
    console.log('\nüè™ ANALISANDO PAINEL DO LOJISTA');
    console.log('-'.repeat(40));

    const merchantPages = [
      { path: '/merchant/dashboard', name: 'Dashboard', component: 'MerchantDashboard' },
      { path: '/merchant/sales', name: 'Vendas', component: 'MerchantSales' },
      { path: '/merchant/products', name: 'Produtos', component: 'MerchantProducts' },
      { path: '/merchant/transactions', name: 'Transa√ß√µes', component: 'MerchantTransactions' },
      { path: '/merchant/customers', name: 'Clientes', component: 'MerchantCustomers' },
      { path: '/merchant/reports', name: 'Relat√≥rios', component: 'MerchantReports' },
      { path: '/merchant/profile', name: 'Perfil', component: 'MerchantProfile' },
      { path: '/merchant/settings', name: 'Configura√ß√µes', component: 'MerchantSettings' },
      { path: '/merchant/payment-qr', name: 'QR de Pagamento', component: 'MerchantPaymentQR' },
      { path: '/merchant/withdrawals', name: 'Saques', component: 'MerchantWithdrawals' }
    ];

    for (const page of merchantPages) {
      const componentPath = `client/src/pages/merchant/${page.component.toLowerCase().replace('merchant', '')}.tsx`;
      const exists = fs.existsSync(componentPath);
      
      if (exists) {
        try {
          const content = fs.readFileSync(componentPath, 'utf8');
          const hasQuery = content.includes('useQuery');
          const hasAPI = content.includes('/api/');
          const hasAuth = content.includes('useAuth');
          
          console.log(`‚úÖ ${page.name}: Componente OK (Query: ${hasQuery}, API: ${hasAPI}, Auth: ${hasAuth})`);
          this.results.merchantPanel.tests.push({
            name: page.name,
            path: page.path,
            status: 'pass',
            features: { hasQuery, hasAPI, hasAuth }
          });
        } catch (error) {
          console.log(`‚ö†Ô∏è ${page.name}: Erro ao analisar componente`);
          this.results.merchantPanel.tests.push({
            name: page.name,
            path: page.path,
            status: 'warning',
            error: error.message
          });
        }
      } else {
        console.log(`‚ùå ${page.name}: Componente n√£o encontrado`);
        this.results.merchantPanel.tests.push({
          name: page.name,
          path: page.path,
          status: 'fail',
          error: 'Componente n√£o encontrado'
        });
      }
    }

    this.results.merchantPanel.status = 'completed';
  }

  async analyzeAdminPanel() {
    console.log('\n‚öôÔ∏è ANALISANDO PAINEL DO ADMINISTRADOR');
    console.log('-'.repeat(40));

    const adminPages = [
      { path: '/admin/dashboard', name: 'Dashboard', component: 'AdminDashboard' },
      { path: '/admin/users', name: 'Usu√°rios', component: 'AdminUsers' },
      { path: '/admin/customers', name: 'Clientes', component: 'AdminCustomers' },
      { path: '/admin/merchants', name: 'Lojistas', component: 'AdminMerchants' },
      { path: '/admin/transactions', name: 'Transa√ß√µes', component: 'AdminTransactions' },
      { path: '/admin/transfers', name: 'Transfer√™ncias', component: 'AdminTransfers' },
      { path: '/admin/withdrawals', name: 'Saques', component: 'AdminWithdrawals' },
      { path: '/admin/reports', name: 'Relat√≥rios', component: 'AdminReports' },
      { path: '/admin/settings', name: 'Configura√ß√µes', component: 'AdminSettings' },
      { path: '/admin/logs', name: 'Logs', component: 'AdminLogs' }
    ];

    for (const page of adminPages) {
      const componentPath = `client/src/pages/admin/${page.component.toLowerCase().replace('admin', '')}.tsx`;
      const exists = fs.existsSync(componentPath);
      
      if (exists) {
        try {
          const content = fs.readFileSync(componentPath, 'utf8');
          const hasQuery = content.includes('useQuery');
          const hasAPI = content.includes('/api/');
          const hasAuth = content.includes('useAuth');
          
          console.log(`‚úÖ ${page.name}: Componente OK (Query: ${hasQuery}, API: ${hasAPI}, Auth: ${hasAuth})`);
          this.results.adminPanel.tests.push({
            name: page.name,
            path: page.path,
            status: 'pass',
            features: { hasQuery, hasAPI, hasAuth }
          });
        } catch (error) {
          console.log(`‚ö†Ô∏è ${page.name}: Erro ao analisar componente`);
          this.results.adminPanel.tests.push({
            name: page.name,
            path: page.path,
            status: 'warning',
            error: error.message
          });
        }
      } else {
        console.log(`‚ùå ${page.name}: Componente n√£o encontrado`);
        this.results.adminPanel.tests.push({
          name: page.name,
          path: page.path,
          status: 'fail',
          error: 'Componente n√£o encontrado'
        });
      }
    }

    this.results.adminPanel.status = 'completed';
  }

  async analyzeComponents() {
    console.log('\nüß© ANALISANDO COMPONENTES DO SISTEMA');
    console.log('-'.repeat(40));

    const criticalComponents = [
      'client/src/components/layout/dashboard-layout.tsx',
      'client/src/components/ui/data-table.tsx',
      'client/src/components/ui/stat-card.tsx',
      'client/src/components/ui/charts.tsx',
      'client/src/hooks/use-auth.tsx',
      'client/src/lib/queryClient.ts',
      'client/src/lib/protected-route.tsx'
    ];

    for (const componentPath of criticalComponents) {
      const exists = fs.existsSync(componentPath);
      const componentName = path.basename(componentPath, '.tsx');
      
      if (exists) {
        try {
          const content = fs.readFileSync(componentPath, 'utf8');
          const hasExports = content.includes('export');
          const hasTypes = content.includes('interface') || content.includes('type');
          
          console.log(`‚úÖ ${componentName}: OK (Exports: ${hasExports}, Types: ${hasTypes})`);
          this.results.components.tests.push({
            name: componentName,
            path: componentPath,
            status: 'pass',
            features: { hasExports, hasTypes }
          });
        } catch (error) {
          console.log(`‚ö†Ô∏è ${componentName}: Erro ao analisar`);
          this.results.components.tests.push({
            name: componentName,
            path: componentPath,
            status: 'warning',
            error: error.message
          });
        }
      } else {
        console.log(`‚ùå ${componentName}: N√£o encontrado`);
        this.results.components.tests.push({
          name: componentName,
          path: componentPath,
          status: 'fail',
          error: 'Componente n√£o encontrado'
        });
      }
    }

    this.results.components.status = 'completed';
  }

  generateReport() {
    console.log('\nüìã RELAT√ìRIO FINAL DA AN√ÅLISE');
    console.log('='.repeat(60));

    const sections = [
      { name: 'Banco de Dados', key: 'database' },
      { name: 'APIs', key: 'apis' },
      { name: 'Autentica√ß√£o', key: 'authentication' },
      { name: 'Painel Cliente', key: 'clientPanel' },
      { name: 'Painel Lojista', key: 'merchantPanel' },
      { name: 'Painel Admin', key: 'adminPanel' },
      { name: 'Componentes', key: 'components' }
    ];

    let totalTests = 0;
    let passedTests = 0;
    let failedTests = 0;
    let warnings = 0;

    sections.forEach(section => {
      const result = this.results[section.key];
      const tests = result.tests;
      const passed = tests.filter(t => t.status === 'pass').length;
      const failed = tests.filter(t => t.status === 'fail').length;
      const warned = tests.filter(t => t.status === 'warning').length;
      
      totalTests += tests.length;
      passedTests += passed;
      failedTests += failed;
      warnings += warned;
      
      const status = failed > 0 ? '‚ùå' : warned > 0 ? '‚ö†Ô∏è' : '‚úÖ';
      console.log(`${status} ${section.name}: ${passed}/${tests.length} OK (${failed} falhas, ${warned} avisos)`);
    });

    console.log('\nüìä RESUMO GERAL:');
    console.log(`   Total de testes: ${totalTests}`);
    console.log(`   ‚úÖ Passou: ${passedTests} (${((passedTests/totalTests)*100).toFixed(1)}%)`);
    console.log(`   ‚ùå Falhou: ${failedTests} (${((failedTests/totalTests)*100).toFixed(1)}%)`);
    console.log(`   ‚ö†Ô∏è Avisos: ${warnings} (${((warnings/totalTests)*100).toFixed(1)}%)`);

    // Salvar relat√≥rio detalhado
    const reportPath = 'system-analysis-report.json';
    fs.writeFileSync(reportPath, JSON.stringify(this.results, null, 2));
    console.log(`\nüìÑ Relat√≥rio detalhado salvo em: ${reportPath}`);

    // Recomenda√ß√µes
    console.log('\nüí° RECOMENDA√á√ïES:');
    if (failedTests > 0) {
      console.log('   üîß Corrigir componentes com falhas');
    }
    if (warnings > 0) {
      console.log('   ‚ö†Ô∏è Revisar componentes com avisos');
    }
    if (failedTests === 0 && warnings === 0) {
      console.log('   üéâ Sistema est√° funcionando corretamente!');
    }
  }
}

// Executar an√°lise
const analyzer = new SystemAnalyzer();
analyzer.runCompleteAnalysis().catch(console.error);